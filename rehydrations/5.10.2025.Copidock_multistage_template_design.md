---
thread_id: enhanced-se-templating-multi-stage
snapshot_id: multi-stage-hydration-design-v1
version: 1
created_at: 2025-10-05T18:45:00Z
repo: copidock
branch: test_branch
goal: "Multi-stage hydration development system"
persona: senior-backend-dev
focus: "Stage-aware SE templates that evolve with project lifecycle"
output: "Context-aware template system with CLI-configurable project stages"
constraints: "Backwards compatible, CLI-driven, project-lifecycle aware"
---

# Multi-Stage Hydration Development System

## Vision Statement

**Problem**: Current SE templates are too generic and don't distinguish between project stages. When starting a new Pomodoro app, we get infrastructure maintenance tasks for existing Copidock system instead of greenfield project guidance.

**Solution**: **Multi-stage hydration development** where template behavior evolves based on project maturity and lifecycle stage.

## Core Design Insight

### **Current Problem Example:**
```markdown
# User Input
Focus: "Building a scalable Pomodoro app backend"
Output: "Complete REST API with timer management"

# Template Output (WRONG)
### Tasks for This Session
- Review infrastructure changes for breaking dependencies  # ‚Üê Irrelevant for new project
- Validate resource scaling and limits                     # ‚Üê No infrastructure exists yet
- Design rollback strategy                                 # ‚Üê Nothing to roll back from

## Recent Progress
**Recent Commits:**
- `d028fa36`: hydrate/rehydrate (Copidock system)          # ‚Üê Wrong project context
- `3758240e`: did some changes on templating (Copidock)    # ‚Üê Not Pomodoro-related

### NOTEs
1. **s - Store new notes** (lambdas/notes_handler.py)      # ‚Üê 29 Copidock notes, not Pomodoro
```

### **Desired Solution:**
```markdown
# Stage 1: Initial/Greenfield
### Tasks for This Session
- Design Pomodoro timer business logic and state machine
- Choose technology stack (FastAPI vs Flask vs Django)
- Design database schema for users and sessions
- Set up development environment with Docker

# Stage 2: Development (after git history exists)
## Recent Progress  
**Recent Commits:**
- `abc123`: Added timer state machine (2 hours ago)
- `def456`: Implemented user authentication (1 day ago)

### Tasks for This Session
- Implement timer accuracy and drift correction
- Add session persistence to PostgreSQL
```

## Multi-Stage Template System

### **Stage 1: Initial (Greenfield)**
**Characteristics:**
- No relevant git history for new project
- CLI-provided context is primary
- Focus on architecture and setup
- Template ignores existing codebase

**CLI Usage:**
```bash
copidock snapshot create --interactive \
  --stage initial \
  --project-type "backend-api" \
  --domain "pomodoro-timer" \
  --output "Complete REST API with timer management" \
  --constraints "production-ready, scalable architecture"
```

**Template Configuration:**
```yaml
initial_stage:
  use_git_analysis: false
  use_existing_notes: false
  focus_source: cli_provided
  template_variant: greenfield
  
  sections:
    - header_with_cli_context
    - operator_instructions_greenfield
    - technology_selection_guidance
    - architecture_design_tasks
    - expected_outputs_cli
  
  exclude:
    - git_analysis
    - existing_notes
    - recent_commits
    - current_changes
```

**Expected Output:**
```markdown
---
stage: initial
project_type: backend-api
domain: pomodoro-timer
---

## Operator Instructions
You are designing a **new Pomodoro timer backend** from scratch.

### Architecture Decisions Needed
- API framework selection (FastAPI recommended for async timer handling)
- Database choice (PostgreSQL for session persistence)
- Timer accuracy strategy (server-side vs hybrid)
- Real-time communication (WebSocket vs polling)

### Tasks for This Session
- Design timer state machine (work/short-break/long-break)
- Define API endpoints for timer control
- Design user session and preference schema
- Set up development environment
- Plan testing strategy for timer accuracy

### Expected Outputs
Complete REST API with timer management

(No git analysis - this is greenfield)
```

### **Stage 2: Development (Iterative)**
**Characteristics:**
- Git history becomes relevant
- Mix of CLI context + code analysis
- Focus on feature development
- Template uses existing codebase context

**CLI Usage:**
```bash
copidock snapshot create --interactive \
  --stage development \
  --focus "timer accuracy implementation" \
  --output "Working timer with <100ms accuracy"
```

**Template Configuration:**
```yaml
development_stage:
  use_git_analysis: true
  use_existing_notes: true
  focus_source: git_and_cli
  template_variant: iterative
  
  sections:
    - header_with_git_context
    - operator_instructions_iterative
    - recent_progress_analysis
    - current_changes_breakdown
    - context_aware_tasks
    - prioritized_notes
  
  include:
    - git_analysis
    - existing_notes
    - commit_history
    - file_changes
```

**Expected Output:**
```markdown
---
stage: development
project_type: backend-api
domain: pomodoro-timer
---

## Recent Progress
**Recent Commits:**
- `abc123`: Added timer state machine (2 hours ago)
- `def456`: Implemented user authentication (1 day ago)
- `ghi789`: Set up FastAPI project structure (2 days ago)

## Current Changes
- **Backend/API**: 3 files üöÄ
  - `app/models/timer.py` (new timer model)
  - `app/routes/sessions.py` (session endpoints)
  - `app/schemas/user.py` (user validation)

### Tasks for This Session
- Implement timer accuracy and drift correction
- Add session persistence to PostgreSQL
- Design notification system for break reminders

### NOTEs (Project-Relevant)
1. **Timer drift concern** (app/services/timer.py:45)
2. **Session cleanup strategy** (app/models/session.py:23)
```

### **Stage 3: Maintenance**
**Characteristics:**
- Mature codebase with production deployment
- Focus on stability and optimization
- Full git analysis and historical context
- Template emphasizes risk management

## Enhanced CLI Design

### **Stage-Aware Parameters:**
```bash
# Auto-detect stage (default behavior)
copidock snapshot create --interactive

# Explicit stage specification
copidock snapshot create --interactive --stage initial|development|maintenance

# Project context for initial stage
copidock snapshot create --interactive \
  --stage initial \
  --project-type "backend-api|cli-tool|data-pipeline|mobile-backend" \
  --domain "pomodoro|e-commerce|analytics|social" \
  --tech-stack "fastapi,postgresql,docker" \
  --target-scale "MVP for 100 users|1K users|10K users" \
  --timeline "sprint|month|quarter"
```

### **Template Selection Logic:**
```python
def select_template_strategy(stage, context):
    """Configure template strategy based on project stage"""
    
    if stage == "initial":
        return {
            'use_git_analysis': False,
            'use_existing_notes': False,
            'focus_source': 'cli_provided',
            'template_variant': 'greenfield',
            'sections': ['cli_context', 'architecture_guidance', 'setup_tasks']
        }
    
    elif stage == "development":
        return {
            'use_git_analysis': True,
            'use_existing_notes': True,
            'focus_source': 'git_and_cli',
            'template_variant': 'iterative',
            'sections': ['git_context', 'progress_analysis', 'development_tasks']
        }
    
    elif stage == "maintenance":
        return {
            'use_git_analysis': True,
            'use_existing_notes': True,
            'focus_source': 'comprehensive',
            'template_variant': 'production_aware',
            'sections': ['full_context', 'risk_analysis', 'stability_tasks']
        }

def detect_project_stage(repo_root, cli_stage=None):
    """Auto-detect project stage from repository state"""
    
    if cli_stage and cli_stage != "auto":
        return cli_stage
    
    # Auto-detection logic
    if not has_main_application_files(repo_root):
        return "initial"
    elif is_feature_branch() or has_recent_development_activity():
        return "development"  
    elif has_production_deployment() or is_main_branch_with_releases():
        return "maintenance"
    
    return "development"  # Default fallback
```

## Implementation Strategy

### **Phase 1: CLI Enhancement**
```python
@app.command("snapshot")
def snapshot_cmd(
    # ... existing params ...
    stage: str = typer.Option("auto", "--stage", help="Project stage: auto, initial, development, maintenance"),
    project_type: Optional[str] = typer.Option(None, "--project-type", help="backend-api, cli-tool, data-pipeline"),
    domain: Optional[str] = typer.Option(None, "--domain", help="Project domain: pomodoro, e-commerce, etc"),
    tech_stack: Optional[str] = typer.Option(None, "--tech-stack", help="Comma-separated: fastapi,postgresql,docker"),
    target_scale: Optional[str] = typer.Option(None, "--target-scale", help="MVP, 1K users, 10K users"),
):
    """Create development snapshot with stage-aware templates"""
    
    # Detect or use provided stage
    detected_stage = detect_project_stage(repo_root, stage)
    
    # Configure template strategy
    template_strategy = select_template_strategy(detected_stage, context)
    
    # Enhanced interactive flow for initial stage
    if detected_stage == "initial" and interactive:
        # Focus on project setup prompts
        interactive_params = run_initial_stage_flow(context, project_type, domain)
    else:
        # Standard interactive flow
        interactive_params = run_interactive_flow(context, persona, focus, output, constraints)
    
    # Generate stage-aware snapshot
    snapshot = generate_snapshot(template_strategy, context, interactive_params)
```

### **Phase 2: Template Composition System**
```yaml
# Base template blocks
template_blocks:
  greenfield_guidance:
    sections:
      - architecture_decisions
      - technology_selection
      - project_setup_tasks
      - development_environment
  
  development_context:
    sections:
      - recent_progress
      - current_changes
      - development_velocity
      - feature_development_tasks
  
  production_awareness:
    sections:
      - deployment_status
      - risk_assessment
      - stability_tasks
      - monitoring_alerts

# Stage-specific compositions
stage_templates:
  initial:
    inherit: [greenfield_guidance]
    exclude: [git_analysis, existing_notes]
    
  development:
    inherit: [greenfield_guidance, development_context]
    include: [git_analysis, existing_notes]
    
  maintenance:
    inherit: [development_context, production_awareness]
    include: [comprehensive_analysis, risk_management]
```

### **Phase 3: Domain-Specific Templates**
```yaml
domain_templates:
  pomodoro_timer:
    architecture_guidance:
      - "Design timer state machine (work/short-break/long-break)"
      - "Plan timer accuracy strategy (server-side vs hybrid)"
      - "Design session persistence and recovery"
      - "Plan notification and reminder system"
    
    technology_recommendations:
      backend: "FastAPI (async timer handling) or Flask"
      database: "PostgreSQL (session persistence) or Redis (temp state)"
      real_time: "WebSocket (real-time updates) vs polling"
    
    specific_risks:
      - "Timer drift and accuracy issues"
      - "Concurrent session management complexity"
      - "Notification delivery reliability"

  e_commerce:
    architecture_guidance:
      - "Design product catalog and inventory system"
      - "Plan order processing and payment flow"
      - "Design user authentication and authorization"
    
    technology_recommendations:
      backend: "Django (admin interface) or FastAPI"
      database: "PostgreSQL (ACID compliance)"
      payments: "Stripe integration"
```

## Expected Benefits

### **1. Relevant Guidance**
- **Initial stage**: Get architecture and setup guidance, not maintenance tasks
- **Development stage**: Get feature development context from actual git history  
- **Maintenance stage**: Get stability and risk management focus

### **2. CLI-Driven Flexibility**
```bash
# Quick greenfield setup
copidock snapshot create --interactive --stage initial --domain pomodoro

# Focused development session
copidock snapshot create --interactive --focus "WebSocket implementation"

# Production maintenance  
copidock snapshot create --interactive --stage maintenance
```

### **3. Project Lifecycle Continuity**
- Templates evolve with your project
- Context builds up over development iterations
- SE guidance remains relevant to current project phase

## Migration Strategy

### **Backwards Compatibility**
- Default behavior remains unchanged (`--stage auto`)
- Existing templates continue to work
- New features are opt-in via CLI flags

### **Gradual Enhancement**
1. **Phase 1**: Add stage detection and CLI parameters
2. **Phase 2**: Implement stage-aware template selection  
3. **Phase 3**: Add domain-specific template blocks
4. **Phase 4**: Create comprehensive domain template library

## Success Metrics

### **Template Relevance**
- **Initial stage**: 0% infrastructure maintenance tasks for greenfield projects
- **Development stage**: >80% of tasks relevant to current git changes
- **Domain accuracy**: Timer-related tasks for Pomodoro, API tasks for backend projects

### **Developer Experience**
- **Setup time**: <2 minutes from idea to structured project guidance
- **Context accuracy**: SE guidance matches actual project stage and domain
- **Iteration speed**: Fast snapshots for development workflow

---

## Next Steps

1. **Implement stage detection logic** in CLI
2. **Create initial stage template variant** with CLI-driven context
3. **Add domain-specific guidance blocks** for common project types
4. **Test with Pomodoro project** as proof of concept
5. **Iterate based on real usage patterns**

---

*This design document captures the vision for multi-stage hydration development that adapts SE templates to project lifecycle stages, ensuring relevant guidance at every phase of development.*